{% for room in rooms %}
<div class="roomListRoom">
    <div class="roomListRoom__header">
        <a href="{% url 'user-profile' room.host.id %}" class="roomListRoom__author">
            
            {% if room.host.is_online %}
                <div class="avatar avatar--small active">
                    <img src="{{ room.host.avatar.url }}" />
                </div>
                {% else %}
                    <div class="avatar avatar--small">
                        <img src="{{ room.host.avatar.url }}" />
                    </div>
                {% endif %}
            
            <span>@{{ room.host.username }}</span>
        </a>
        <div class="roomListRoom__actions">
            <span>{{ room.created|timesince }} ago</span>
        </div>
    </div>
    <div class="roomListRoom__content">
        <a href="{% url 'room' room.id %}?username={{ request.user.username }}&room_name={{ room.name }}">
            {{ room.name }}
        </a>
    </div>
    <div class="roomListRoom__meta">
        <a href="{% url 'room' room.id %}" class="roomListRoom__joined">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                <title>user-group</title>
                <path
                    d="M30.539 20.766c-2.69-1.547-5.75-2.427-8.92-2.662 0.649 0.291 1.303 0.575 1.918 0.928 0.715 0.412 1.288 1.005 1.71 1.694 1.507 0.419 2.956 1.003 4.298 1.774 0.281 0.162 0.456 0.487 0.456 0.85v4.65h-4v2h5c0.553 0 1-0.447 1-1v-5.65c0-1.077-0.56-2.067-1.461-2.584z">
                </path>
                <path
                    d="M22.539 20.766c-6.295-3.619-14.783-3.619-21.078 0-0.901 0.519-1.461 1.508-1.461 2.584v5.65c0 0.553 0.447 1 1 1h22c0.553 0 1-0.447 1-1v-5.651c0-1.075-0.56-2.064-1.461-2.583zM22 28h-20v-4.65c0-0.362 0.175-0.688 0.457-0.85 5.691-3.271 13.394-3.271 19.086 0 0.282 0.162 0.457 0.487 0.457 0.849v4.651z">
                </path>
                <path
                    d="M19.502 4.047c0.166-0.017 0.33-0.047 0.498-0.047 2.757 0 5 2.243 5 5s-2.243 5-5 5c-0.168 0-0.332-0.030-0.498-0.047-0.424 0.641-0.944 1.204-1.513 1.716 0.651 0.201 1.323 0.331 2.011 0.331 3.859 0 7-3.141 7-7s-3.141-7-7-7c-0.688 0-1.36 0.131-2.011 0.331 0.57 0.512 1.089 1.075 1.513 1.716z">
                </path>
                <path
                    d="M12 16c3.859 0 7-3.141 7-7s-3.141-7-7-7c-3.859 0-7 3.141-7 7s3.141 7 7 7zM12 4c2.757 0 5 2.243 5 5s-2.243 5-5 5-5-2.243-5-5c0-2.757 2.243-5 5-5z">
                </path>
            </svg>
            {{ room.participants.all.count }} Joined
        </a>
        
                <!-- Upvote Button -->
        <a href="#" class="roomListRoom__vote upvote" data-room="{{ room.id }}">{{room.upvote_count }}
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                <title>upvote </title>
                <path d="M16 4l-12 12h8v12h8v-12h8z"></path>
            </svg>
        </a>

        <!-- Downvote Button -->
        <a href="#" class="roomListRoom__vote downvote" data-room="{{ room.id }}"> {{room.downvote_count}}
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                <title>downvote</title>
                <path d="M16 28l12-12h-8v-12h-8v12h-8z"></path>
            </svg>
        </a>
    
        <!-- AI Summarize Button -->
        <!-- AI Summarize Button -->
        <a href="#" class="roomListRoom__ai summarize-btn" data-room="{{ room.id }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                <title>ai-summarize</title>
                <path d="M16 2l-14 14h9v14h10v-14h9z"></path>
            </svg>
        </a>

        <!-- Placeholder for displaying summary -->
        <p class="roomListRoom__topic">{{ room.topic.name }}</p>
    </div>

</div>
<!-- Placeholder for displaying summary -->
<div class="summary-container" id="summary-container-{{ room.id }}">
    <span class="summary-text" id="summary-{{ room.id }}"></span>
</div>


{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".upvote, .downvote").forEach(button => {
        button.addEventListener("click", function(event) {
            event.preventDefault();
            let roomId = this.getAttribute("data-room");
            let voteType = this.classList.contains("upvote") ? "upvote" : "downvote";
            let upvoteCountElem = document.querySelector(`#upvote-count-${roomId}`);
            let downvoteCountElem = document.querySelector(`#downvote-count-${roomId}`);

            fetch(`/room/${roomId}/vote/${voteType}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/json"
                },
                credentials: "same-origin"
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    upvoteCountElem.textContent = data.upvotes;
                    downvoteCountElem.textContent = data.downvotes;

                    document.querySelectorAll(`[data-room="${roomId}"]`).forEach(btn => btn.classList.remove("active"));
                    
                    if (data.user_vote === 1) {
                        document.querySelector(`.upvote[data-room="${roomId}"]`).classList.add("active");
                    } else if (data.user_vote === -1) {
                        document.querySelector(`.downvote[data-room="${roomId}"]`).classList.add("active");
                    }
                } else {
                    location.reload();
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".summarize-btn").forEach(button => {
        let typingIntervals = {}; // Store interval references per room

        button.addEventListener("click", function (event) {
            event.preventDefault();
            let roomId = this.getAttribute("data-room");
            let summaryContainer = document.getElementById(`summary-container-${roomId}`);
            let summaryTextElem = document.getElementById(`summary-${roomId}`);

            // If summarization is in progress, stop it and reset everything
            if (button.getAttribute("data-generating") === "true") {
                clearInterval(typingIntervals[roomId]); // Stop typing effect
                delete typingIntervals[roomId]; // Remove reference
                button.removeAttribute("data-generating");
                summaryTextElem.textContent = ""; // Clear text
                summaryContainer.style.display = "none"; // Hide summary
                return; // Exit function, so it doesn't regenerate
            }

            // If summary already exists, clear it and reset
            if (summaryTextElem.textContent.trim() !== "") {
                summaryTextElem.textContent = ""; // Clear text
                summaryContainer.style.display = "none"; // Hide summary
                return; // Exit function, so it doesn't regenerate
            }

            // Start summarization process
            button.setAttribute("data-generating", "true"); // Mark as generating
            summaryTextElem.textContent = ""; // Clear previous text
            summaryContainer.style.display = "block"; // Show summary container
            summaryTextElem.classList.add("typing-animation"); // Start animation

            fetch(`/summarize-room/${roomId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
            })
            .then(response => response.json())
            .then(data => {
                let summary = data.summary.split(" ");
                let index = 0;

                typingIntervals[roomId] = setInterval(() => {
                    if (index < summary.length) {
                        summaryTextElem.textContent += summary[index] + " ";
                        index++;
                    } else {
                        clearInterval(typingIntervals[roomId]); // Stop typing
                        delete typingIntervals[roomId]; // Remove reference
                        button.removeAttribute("data-generating"); // Mark done
                        summaryTextElem.classList.remove("typing-animation"); // Remove animation
                    }
                }, 300);
            })
            .catch(error => console.error("Error:", error));
        });
    });
});


</script>